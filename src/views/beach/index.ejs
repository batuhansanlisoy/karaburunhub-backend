<div class="container mt-3">
    <div class="d-flex align-items-center gap-2 mb-3">
        <div class="p-2 bg-primary text-white rounded-5 px-4 d-flex align-items-center justify-content-center">
            <h2 class="mb-0 fs-6 text-center"><%= title %></h2>
        </div>
        <button onclick="Slideover.show('/beach/form/create', 'Yeni Koy Ekle')" class="btn btn-dark rounded-5 so-trigger">
            <i class="bi bi-plus-circle me-2"></i>Ekle
        </button>
        <button id="openFilter" class="btn btn-dark rounded-5">
            <i class="bi bi-filter me-2"></i>Filtre
        </button>
        <input type="text" id="searchInput" class="form-control rounded-5" placeholder="Ara..." style="max-width: 250px;">
    </div>

    <%- include('../ui/slideover.ejs') %>
    <%- include('../ui/table.ejs', { title: "Plaj & Koy" }) %>
</div>

<script>
async function refreshTable() {
    try {
        const res = await fetch("/beach/list");
        let data = await res.json();

        const columns = [
            { label: '', key: 'actions', type:"html", width: '25px'},
            { label: 'Konum', key: 'village_name' },
            { label: 'Plaj Adı', key: 'name' },
            { label: 'Adres', key: 'address' },
        ];

        const rows = data.map((item, idx) => {
    // Öne çıkarılma durumuna göre renk belirle
    // Eğer true ise 'text-warning' (sarı) değilse 'text-white' veya 'btn-dark' kalsın
        const highlightClass = item.highlight ? 'text-warning' : 'text-secondary';
        const highlightTitle = item.highlight ? 'Öne Çıkarılmış' : 'Öne Çıkarılmamış';

    return {
        actions: `
            <div class="d-flex">
                <button class="btn btn-dark btn-sm rounded-circle delete-btn" data-id="${item.id}"><i class="bi bi-trash3"></i></button>
                <button class="btn btn-dark btn-sm rounded-circle ms-2 so-trigger edit-btn" data-id="${item.id}"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-dark btn-sm rounded-circle ms-2 so-trigger upload-btn" data-id="${item.id}"><i class="bi bi-upload"></i></button>
                
                <button class="btn btn-dark btn-sm rounded-circle ms-2 highlight-btn ${highlightClass}" 
                        data-id="${item.id}" 
                        data-status="${item.highlight}"
                        title="${highlightTitle}">
                    <i class="bi bi-lightning-fill"></i>
                </button>
            </div>
        `,
        village_name: item.village_name,
        name: item.name,
        address: item.address,
    };
});

        renderTable(columns, rows, "/beach");
    } catch (err) { console.error(err); }
}

async function highlight(beachId, isHighlighted) {
    try {
        const res = await fetch(`/beach/${beachId}/highlight`, { // Başındaki slash'a dikkat /beach...
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ value: isHighlighted })
        });

        if (res.ok) {
            // alert('Güncellendi!'); // Her seferinde alert yormasın dersen kaldırabilirsin
            refreshTable(); // Listeyi yeniden çek ki renk değişsin
        } else {
            alert('Bir hata oluştu!');
        }
    } catch (err) {
        console.error("Hata:", err);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    refreshTable();

    document.addEventListener("click", async (e) => {
        const editBtn = e.target.closest(".edit-btn");
        const uploadBtn = e.target.closest(".upload-btn");
        const highlightBtn = e.target.closest(".highlight-btn");

        if (editBtn) Slideover.show(`/beach/form/edit/${editBtn.dataset.id}`, "Koyu Düzenle");
        if (uploadBtn) Slideover.show(`/beach/form/upload/${uploadBtn.dataset.id}`, "Fotoğraf Yükle");
        if (highlightBtn) {
            const beachId = highlightBtn.dataset.id;
            
            // Status'ü string'den boolean'a çeviriyoruz
            // Eğer "true" metni gelirse veya 1 gelirse true olur
            const currentStatus = highlightBtn.dataset.status === "true" || highlightBtn.dataset.status === "1";
            
            // ŞİMDİ TERSİNE ÇEVİRİYORUZ (1 ise 0, 0 ise 1 yapıyoruz)
            const nextStatus = !currentStatus; 

            const msg = nextStatus 
                ? "Bu işletmeyi mobil uygulamada öne çıkarmak istediğinize emin misiniz?" 
                : "Bu işletmeyi öne çıkarılanlardan kaldırmak istiyor musunuz?"; 

            if (confirm(msg)) {
                // Fonksiyona TERSİNE ÇEVRİLMİŞ halini gönderiyoruz
                highlight(beachId, nextStatus);
            }
        }
    });

    document.getElementById('slideover-content').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        let url = '';
        let config = { method: 'POST' };

        if (form.id === 'edit-form') {
            url = `/beach/${form.dataset.beachId}`;
            config = { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: form.name.value }) 
            };
        } else if (form.id === 'upload-form') {
            url = `/beach/upload/${form.dataset.beachId}`;
            config = { method: 'PUT', body: new FormData(form) };
        } else if (form.id === 'create-form') {
            url = `/beach/create`;
            const payload = Object.fromEntries(new FormData(form));
            config = { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };
        }

        const res = await fetch(url, config);
        if (res.ok) {
            alert('Başarılı!');
            Slideover.hide();
            refreshTable();
        } else {
            alert('Hata oluştu!');
        }
    });
});
</script>
